<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
  <meta name="generator" content="HTML Tidy for HTML5 for Linux version 5.2.0">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width; target-densityDpi=160; initial-scale=1; maximum-scale=1">
  <meta name="description" content="Personal blog of John Novak">
  <meta name="author" content="John Novak">
  <meta name="Generator" content="Jekyll (https://jekyllrb.com/)">
  <title>A minimalist Openbox desktop for Vim freaks</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=UnifrakturMaguntia">
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700,400italic,700italic"><!--Source Sans Pro is required for the SVG images only -->
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inconsolata:400,700">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inconsolata:400,700">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Astloch">
  <link rel="stylesheet" type="text/css" href="https://blog.johnnovak.net/css/blog.css">
  <link rel="stylesheet" type="text/css" href="https://blog.johnnovak.net/css/jqmath-0.4.6.css">
  <link rel="stylesheet" type="text/css" href="https://blog.johnnovak.net/css/photoswipe.css">
  <link rel="stylesheet" type="text/css" href="https://blog.johnnovak.net/css/photoswipe-default-skin/default-skin.css">
  <script src="https://blog.johnnovak.net/js/lib/modernizr.min.js" charset="utf-8">
  </script>
  <script src="https://blog.johnnovak.net/js/lib/jquery-1.12.4.min.js" charset="utf-8">
  </script>
  <script src="https://blog.johnnovak.net/js/lib/jqmath-etc-0.4.6.min.js" charset="utf-8">
  </script>
  <script src="https://blog.johnnovak.net/js/lib/photoswipe.min.js" charset="utf-8">
  </script>
  <script src="https://blog.johnnovak.net/js/lib/photoswipe-ui-default.min.js" charset="utf-8">
  </script>
  <script src="https://blog.johnnovak.net/js/blog.js" charset="utf-8">
  </script><!-- <script>M.MathPlayer = false; M.trustHtml = true;</script> -->
  <link rel="alternate" type="application/rss+xml" title="Personal blog of John Novak" href="https://blog.johnnovak.net/feed.xml">
</head>
<body>
  <script src="https://blog.johnnovak.net/js/lib/respond.min.js">
  </script>
  <div id="wrapper">
    <header id="header">
      <div id="header-bg"></div><a href="https://blog.johnnovak.net"><img id="jn-logo" src="https://blog.johnnovak.net/img/jn-logo.png" alt="John Novak" data-2x="https://blog.johnnovak.net/img/jn-logo@2x.png"></a>
      <p class="tagline">Riding on the tail of the<br>
      Gaussian curve<br>
      since 1979</p>
      <nav>
        <ul>
          <li>
            <a href="https://blog.johnnovak.net/about/">About</a>
          </li>
          <li>
            <a href="https://blog.johnnovak.net/archives/">Archives</a>
          </li>
          <li>
            <a href="https://blog.johnnovak.net/tags/">Tags</a>
          </li>
          <li class="last">
            <a href="https://blog.johnnovak.net/feed.xml">Rss</a>
          </li>
        </ul>
      </nav>
    </header>
    <div role="main">
      <article class="post">
        <header>
          <h1><a href="https://blog.johnnovak.net/2016/11/13/a-minimalist-openbox-desktop-for-vim-freaks/">A minimalist Openbox desktop for Vim freaks</a></h1>
          <p class="date"><time datetime="2016-11-13">2016 Nov 13</time></p>
        </header>
        <nav class="tags">
          <ul>
            <li>
              <a href="https://blog.johnnovak.net/tag/linux/">linux</a>
            </li>
            <li>
              <a href="https://blog.johnnovak.net/tag/openbox/">openbox</a>
            </li>
            <li>
              <a href="https://blog.johnnovak.net/tag/crunchbang++/">crunchbang++</a>
            </li>
            <li>
              <a href="https://blog.johnnovak.net/tag/vim/">vim</a>
            </li>
          </ul>
        </nav>
        <p class="intro">Are you the sort of person who is looking for a Vim plugin for everything? Does having to reach out for the mouse sideways cause you involuntary facial muscles twitches? Is breaking out the arrow keys with a screwdriver among the first few things you do on a new computer (after swapping Caps Lock with Left Ctrl, of course)? Then welcome, you’re among friends here.</p>
        <p id="toc-header">Table of contents</p>
        <ul id="markdown-toc">
          <li>
            <a href="#overview" id="markdown-toc-overview">Overview</a>
          </li>
          <li>
            <a href="#philosophy--main-features" id="markdown-toc-philosophy--main-features">Philosophy & main features</a>
          </li>
          <li>
            <a href="#some-implementation-details" id="markdown-toc-some-implementation-details">Some implementation details</a>
            <ul>
              <li>
                <a href="#navigation" id="markdown-toc-navigation">Navigation</a>
                <ul>
                  <li>
                    <a href="#vim--tmux" id="markdown-toc-vim--tmux">Vim & tmux</a>
                  </li>
                  <li>
                    <a href="#xmodmap" id="markdown-toc-xmodmap">xmodmap</a>
                  </li>
                  <li>
                    <a href="#openbox" id="markdown-toc-openbox">Openbox</a>
                  </li>
                </ul>
              </li>
              <li>
                <a href="#clipboard-support" id="markdown-toc-clipboard-support">Clipboard support</a>
                <ul>
                  <li>
                    <a href="#vim" id="markdown-toc-vim">Vim</a>
                  </li>
                  <li>
                    <a href="#tmux" id="markdown-toc-tmux">tmux</a>
                  </li>
                </ul>
              </li>
              <li>
                <a href="#mouse-support" id="markdown-toc-mouse-support">Mouse support</a>
                <ul>
                  <li>
                    <a href="#vim-1" id="markdown-toc-vim-1">Vim</a>
                  </li>
                  <li>
                    <a href="#tmux-1" id="markdown-toc-tmux-1">tmux</a>
                  </li>
                </ul>
              </li>
            </ul>
          </li>
          <li>
            <a href="#installation" id="markdown-toc-installation">Installation</a>
          </li>
          <li>
            <a href="#on-first-boot" id="markdown-toc-on-first-boot">On first boot</a>
            <ul>
              <li>
                <a href="#set-zsh-as-the-default-shell" id="markdown-toc-set-zsh-as-the-default-shell">Set zsh as the default shell</a>
              </li>
              <li>
                <a href="#install-virtualbox-guest-additions" id="markdown-toc-install-virtualbox-guest-additions">Install VirtualBox Guest Additions</a>
              </li>
              <li>
                <a href="#perform-system-update" id="markdown-toc-perform-system-update">Perform system update</a>
              </li>
              <li>
                <a href="#fix-compton" id="markdown-toc-fix-compton">Fix Compton</a>
              </li>
              <li>
                <a href="#enable-autologin" id="markdown-toc-enable-autologin">Enable autologin</a>
              </li>
              <li>
                <a href="#installing-powerline-fonts" id="markdown-toc-installing-powerline-fonts">Installing Powerline fonts</a>
              </li>
              <li>
                <a href="#setting-the-right-wallpaper" id="markdown-toc-setting-the-right-wallpaper">Setting the <em>right</em> wallpaper</a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#further-reading" id="markdown-toc-further-reading">Further reading</a>
          </li>
        </ul>
        <h2 id="overview">Overview</h2>
        <p>Now that we’re done with the formalities and have dissuaded normal computer users and non-fanatical Vim aficionados from reading any further, let’s get to the good stuff! I vastly prefer to use a Linux desktop for development and my trusty 32-bit Crunchbang Waldorf VM has just reached the end of its useful life because of my sudden realisation that I really need 64-bit support. I had spent a considerable time “vimifying” my old setup (more on that later), which, of course, I wanted to carry over to the new installation. This post documents all the hackery I needed to do on the stock install to achieve that.</p>
        <p>We will use <a href="https://crunchbangplusplus.org/">Crunchbang++ 1.0</a> 64-bit as our starting point which is based on <a href="https://www.debian.org/">Debian Jessie</a> stable. Why not use vanilla Debian instead? Because I really like the choices <a href="https://corenominal.org/about/">Philip Newborough</a> had made for the original Crunchbang series and it would be an awful lot of work to replicate them from scratch. Crunchbang is small, fast, stable and prioritises function over form—it’s the perfect Openbox based system for a minimalist. Instead of reinventing everything, we will just make a few strategic tweaks here and there to make it more Vim friendly.</p>
        <p>Why VM? Because I also do <a href="https://music.johnnovak.net/">music</a>, <a href="https://www.johnnovak.net/">graphics design</a> and <a href="https://photo.johnnovak.net/">photography</a>, and most creative apps on Linux just suck<sup id="fnref:linuxsucks"><a href="#fn:linuxsucks" class="footnote">1</a></sup>, plus I don’t like dual booting. The performance hit is negligible nowadays anyway on these new 4 or 8 core Intel i7 CPUs. But most of the instructions will be applicable to non-VM installs as well as I will always make it clear whether a particular step is VM specific or not.</p>
        <p>The bulk of the information presented in this article is a distillation of ideas, tips and config snippets from various online sources far too numerous to mention (or even just remember). Still, the <a href="http://crunchbang.org/forums/">old Crunchbang forums</a> and the excellent <a href="https://wiki.archlinux.org/">ArchLinux wiki</a> definitely stand out as the two best sources of quality information on more arcane issues that you can’t always figure out by reading the man pages alone.</p>
        <h2 id="philosophy--main-features">Philosophy & main features</h2>
        <p>Although I like the concept of tiling window managers, after analysing my common usage patterns I realised that they would be an overkill for my needs. Most of the time I just use tmux inside a maximised terminal window and I rarely use more than a single window per desktop. I like to put my browser windows (Firefox with <a href="http://www.vimperator.org/vimperator">Vimperator</a>) and PDF viewers (<a href="http://mupdf.com/">mupdf</a>) onto separate desktops, so I just need a way to quickly switch between them. Sometimes I need to view two vertically maximised windows side-by-side on the same desktop (e.g. a terminal and a PDF viewer), but that’s pretty much it. Anything else is so infrequent and random that it can be just done easily with the mouse, which is less than 5% of the total use cases, so efficiency really doesn’t matter there. The important thing is that 95% of the time I won’t need to lift my fingers off the home row with this configuration!</p>
        <p>So with all this in mind, let’s take a look at the main features on a high-level:</p>
        <dl>
          <dt>Minimal & highly functional interface</dt>
          <dd>I find the default Crunchbang theme just perfect, so we will be building everything on top of that. The main components of the setup will be Openbox, zsh, urxvt, tmux and—of course—Vim.</dd>
          <dt>Global Vim-style navigation</dt>
          <dd>Seamless navigation between Vim splits and tmux panes and a Vim-like way to switch between 4 virtual desktops.</dd>
          <dt>System clipboard support</dt>
          <dd>While Vim and tmux have their own internal clipboards, other GUI apps generally use the system clipboard, so we’ll need to invent a sane mechanism to interoperate between them.</dd>
          <dt>Mouse support</dt>
          <dd>I don’t use the mouse very much, but when I do, I want it to work correctly in tmux and Vim (e.g. changing focus, resizing panes, selecting & middle-click pasting text etc.)</dd>
          <dt>Unified colour scheme</dt>
          <dd>
            I really like the <a href="https://github.com/jonathanfilip/vim-lucius">Lucius</a> Vim colour scheme (the default dark variant), so the whole setup will use Lucius dark colours consistently.
          </dd>
        </dl>
        <p>And now some screenshots, because everybody loves screenshots!</p>
        <figure class="image">
          <a class="largeimg" href="https://blog.johnnovak.net/files/2016-11-13/desktop1.png" data-width="1920" data-height="1080"><img src="https://blog.johnnovak.net/files/2016-11-13/desktop1-small.jpg" alt="Figure 1 — urxvt + tmux + Vim. That's how I'm spending way too much of my waking time inside a darkened room. The x86 assembly listing in the top right pane serves an important dual purpose: firstly, it is an attempt to make my programmer peers believe that I &lt;em&gt;really know a lot&lt;/em&gt; about computers, and secondly, it distances me from JavaScript wielding hipsters." style="width: 100%"></a>
          <figcaption style="">
            Figure 1 — urxvt + tmux + Vim. That's how I'm spending way too much of my waking time inside a darkened room. The x86 assembly listing in the top right pane serves an important dual purpose: firstly, it is an attempt to make my programmer peers believe that I <em>really know a lot</em> about computers, and secondly, it distances me from JavaScript wielding hipsters.
          </figcaption>
        </figure>
        <figure class="image">
          <a class="largeimg" href="https://blog.johnnovak.net/files/2016-11-13/desktop2.png" data-width="1920" data-height="1080"><img src="https://blog.johnnovak.net/files/2016-11-13/desktop2-small.jpg" alt="Figure 2 — Another common use-case showcasing the window tiling functionality. Yes, the browser window shows the post you are reading right now (plus a Vimperator window, signalling my technical expertise to those in the know). Life is a big recursion, is it not? Also note the common staple of wannabe l33t Linux haxxorz, the ubiquitous tmux clock." style="width: 100%"></a>
          <figcaption style="">
            Figure 2 — Another common use-case showcasing the window tiling functionality. Yes, the browser window shows the post you are reading right now (plus a Vimperator window, signalling my technical expertise to those in the know). Life is a big recursion, is it not? Also note the common staple of wannabe l33t Linux haxxorz, the ubiquitous tmux clock.
          </figcaption>
        </figure>
        <figure class="image">
          <a class="largeimg" href="https://blog.johnnovak.net/files/2016-11-13/desktop3.png" data-width="1920" data-height="1080"><img src="https://blog.johnnovak.net/files/2016-11-13/desktop3-small.jpg" alt="Figure 3 — The obligatory 'just showing off' screenshot because I like the number three. Thunar makes an appearance here." style="width: 100%"></a>
          <figcaption style="">
            Figure 3 — The obligatory "just showing off" screenshot because I like the number three. Thunar makes an appearance here too.
          </figcaption>
        </figure>
        <h2 id="some-implementation-details">Some implementation details</h2>
        <p>In the following sub-sections we’ll take a detailed look at some of the more difficult to configure features. I won’t go through every single line in every config file because then I would be sitting here writing this article for the next two months… Just take a look at <a href="https://github.com/johnnovak/dotfiles">my dotfiles</a> if you’re interested, or better yet, clone/download the repo and run <code>install.sh</code> to set it up on your system. The installer assumes a vanilla <a href="https://crunchbangplusplus.org/">Crunchbang++ 1.0</a> with some extra packages. The second part of this article provides detailed instructions on how to set up the whole thing from scratch into a new VirtualBox VM (mostly for my own reference, but perhaps others will find it useful too).</p>
        <h3 id="navigation">Navigation</h3>
        <h4 id="vim--tmux">Vim & tmux</h4>
        <p>Seamless navigation among Vim splits and tmux panes is accomplished via the excellent <a href="https://github.com/christoomey/vim-tmux-navigator">Vim Tmux Navigator</a>. We’ll just use the default settings that will use the shortcuts <kbd>Ctrl</kbd>+<kbd>H</kbd><kbd>J</kbd><kbd>K</kbd><kbd>L</kbd> to move between panes.</p>
        <p>A side effect of this configuration is that we won’t be able to use <kbd>Ctrl</kbd>+<kbd>L</kbd> to clear the terminal anymore. There’s an easy workaround for that; we’ll remap <kbd>Ctrl</kbd>+<kbd>L</kbd> to <kbd>&lt;Prefix&gt;</kbd>+<kbd>Ctrl</kbd>+<kbd>L</kbd> in the tmux config:</p>
        <pre><code>bind C-l send-keys "C-l"
</code></pre>
        <h4 id="xmodmap">xmodmap</h4>
        <p>Hey, wait a minute, chief! What’s xmodmap doing here? xmodmap is a tool for modifying X keymaps and mouse button mappings. We are going to use it to differentiate between the left and right <kbd>Alt</kbd> modifiers when defining our Openbox shortcuts. I happened to come up with this bright idea of switching between desktops 1 to 4 with <kbd>R Alt</kbd>+<kbd>J</kbd><kbd>K</kbd><kbd>L</kbd><kbd>;</kbd> and to send the current window to another desktop with <kbd>L Alt</kbd>+<kbd>R Alt</kbd>+<kbd>J</kbd><kbd>K</kbd><kbd>L</kbd><kbd>;</kbd>. Try them out, they’re really comfortable and quick to use from the home row if you pressed the <kbd>Alt</kbd> buttons with your thumbs!</p>
        <p>This is how our <code>~/.Xmodmap</code> file will look like. First, we’ll need to map the keycode of <kbd>L Alt</kbd> to <code>Alt_L</code> and <kbd>R Alt</kbd> to <code>Hyper_R</code>. Why <code>Hyper_R</code> and not <code>Alt_R</code>? Well, because my keyboard happens to generate the keycode for <code>Hyper_R</code> when I press <kbd>R Alt</kbd>. To find out the exact keycode for your keyboard (it might be different), use the <code>xev</code> (X Event Viewer) utility.</p>
        <pre><code>keycode 64 = Alt_L NoSymbol Alt_L
keycode 108 = Hyper_R NoSymbol Hyper_R
</code></pre>
        <p>After this, we’ll clear all existing modifier bindings and set our own. This is not strictly necessary as we’re just setting the defaults again for most, but I find this method cleaner and easier to troubleshoot because then we can see all the modifier definitions in one place.</p>
        <pre><code>clear Shift
clear Control
clear Mod1
clear Mod2
clear Mod3
clear Mod4
clear Mod5

add Shift = Shift_L Shift_R
add Control = Control_L Control_R
add Mod1 = Alt_L
add Mod2 = Num_Lock
add Mod3 = Hyper_R
add Mod4 = Super_L
add Mod5 = ISO_Level3_Shift
</code></pre>
        <p>There’s one very confusing and non-obvious thing about this config that I will illustrate with a concrete example. We are mapping <code>Hyper_R</code> to <code>Mod3</code>, yet in our Openbox config we won’t be using <code>Mod3</code> for any of the keybindings, but just the hyper key directly (e.g. <code>A-H-j</code>, which stands for Alt-Hyper-j, which will be bound to <kbd>L Alt</kbd>+<kbd>R Alt</kbd>+<kbd>J</kbd>). The logical conclusion would be that we won’t need to bind anything to <code>Mod3</code> then. Not so! Due to the <a href="https://bugs.freedesktop.org/show_bug.cgi?id=926">extremely arcane ways</a> how applications need to communicate with the X server, Openbox can only get keydown events for a modifier key if it is bound to one of the <code>Mod*</code> modifiers. I’m sure the real situation is even more messy and complicated than that, but this is all we need to know for our purposes.</p>
        <p>One more thing, I like to switch <kbd>Caps Lock</kbd> with <kbd>L Ctrl</kbd> on all my computers, but we won’t need to do that here because I’m using <a href="https://sharpkeys.codeplex.com/">SharpKeys</a> on Windows for that purpose, and luckily the settings carry over to the guest VM.</p>
        <h4 id="openbox">Openbox</h4>
        <p>Ok, time to teach Openbox a few new tricks as well. Let’s start with setting the number of desktops to four in <code>~/.config/openbox/rc.xml</code>:</p>
        <pre><code>&lt;desktops&gt;
  &lt;number&gt;4&lt;/number&gt;
  &lt;firstdesk&gt;1&lt;/firstdesk&gt;
  &lt;names&gt;
    &lt;name&gt;1&lt;/name&gt;
    &lt;name&gt;2&lt;/name&gt;
    &lt;name&gt;3&lt;/name&gt;
    &lt;name&gt;4&lt;/name&gt;
  &lt;/names&gt;
  &lt;popupTime&gt;875&lt;/popupTime&gt;
&lt;/desktops&gt;
</code></pre>
        <p>Then we’ll disable the window decorations for <code>urvxt</code> and <code>terminator</code> because they look much cooler that way:</p>
        <pre><code>&lt;application name="terminator"&gt;
  &lt;decor&gt;no&lt;/decor&gt;
&lt;/application&gt;
&lt;application name="urxvt"&gt;
  &lt;decor&gt;no&lt;/decor&gt;
&lt;/application&gt;
</code></pre>
        <p>To recap, this is the final list of shortcuts for our Vim-style desktop (in addition to the standard stuff like <kbd>L Alt</kbd>+<kbd>Tab</kbd> to switch between windows etc.):</p>
        <table class="no-border">
          <tr>
            <td class="shortcut"><kbd>Ctrl</kbd>+<kbd>H</kbd><kbd>J</kbd><kbd>K</kbd><kbd>L</kbd></td>
            <td>Move between Vim splits & tmux panels</td>
          </tr>
          <tr>
            <td class="shortcut"><kbd>R Alt</kbd>+<kbd>J</kbd><kbd>K</kbd><kbd>L</kbd><kbd>;</kbd></td>
            <td>Switch to desktop 1 to 4</td>
          </tr>
          <tr>
            <td class="shortcut"><kbd>L Alt</kbd>+<kbd>R Alt</kbd>+<kbd>J</kbd><kbd>K</kbd><kbd>L</kbd><kbd>;</kbd></td>
            <td>Send window to desktop 1 to 4</td>
          </tr>
          <tr>
            <td class="shortcut"><kbd>Win</kbd>+<kbd>Shift</kbd>+<kbd>H</kbd><kbd>J</kbd><kbd>K</kbd><kbd>;</kbd></td>
            <td>Half-screen tile window</td>
          </tr>
        </table>
        <p>The only thing left to do is to remap the existing keybindings in <code>rc.xml</code>. For example, this is how the desktop switching shortcuts look like. Note that we need to bind to <code>H-x</code> (Hyper + x) for the shortcut <kbd>R Alt</kbd>+<kbd>X</kbd>. Another interesting thing to note is that the key <kbd>;</kbd> (semicolon) has to be specified by its keycode (47 decimal, 0x2f hex). Again, <code>xev</code> is your friend to find out the keycode for a particular key.</p>
        <pre><code>&lt;keybind key="H-j"&gt;
  &lt;action name="GoToDesktop"&gt;
    &lt;to&gt;1&lt;/to&gt;
  &lt;/action&gt;
&lt;/keybind&gt;
&lt;keybind key="H-k"&gt;
  &lt;action name="GoToDesktop"&gt;
    &lt;to&gt;2&lt;/to&gt;
  &lt;/action&gt;
&lt;/keybind&gt;
&lt;keybind key="H-l"&gt;
  &lt;action name="GoToDesktop"&gt;
    &lt;to&gt;3&lt;/to&gt;
  &lt;/action&gt;
&lt;/keybind&gt;
&lt;keybind key="H-0x2f"&gt;
  &lt;action name="GoToDesktop"&gt;
    &lt;to&gt;4&lt;/to&gt;
  &lt;/action&gt;
&lt;/keybind&gt;
</code></pre>
        <p>The send to desktop bindings will be very similar. Here’s the first one from which you can figure out the rest:</p>
        <pre><code>&lt;keybind key="A-H-j"&gt;
  &lt;action name="SendToDesktop"&gt;
    &lt;to&gt;1&lt;/to&gt;
  &lt;/action&gt;
&lt;/keybind&gt;
</code></pre>
        <p>Finally, we’ll just need to remap the existing window tiling shortcuts and we’re done. Example for tile left:</p>
        <pre><code>&lt;keybind key="W-S-h"&gt;          # HalfLeftScreen
  &lt;action name="UnmaximizeFull"/&gt;
  &lt;action name="MoveResizeTo"&gt;
    &lt;x&gt;0&lt;/x&gt;
    &lt;y&gt;0&lt;/y&gt;
    &lt;height&gt;100%&lt;/height&gt;
    &lt;width&gt;50%&lt;/width&gt;
  &lt;/action&gt;
&lt;/keybind&gt;
</code></pre>
        <h3 id="clipboard-support">Clipboard support</h3>
        <p>Getting the shared system clipboard (X11 selections) to work consistently across different GUI and command line apps on Linux can undoubtedly be a hair loss-inducing experience. One of the sources of confusion is that we are usually dealing with two clipboards in X11, not just one like on Windows or OS X. First, there’s the normal clipboard most well-behaved GUI apps use for the <kbd>Ctrl</kbd>+<kbd>X</kbd><kbd>C</kbd><kbd>V</kbd> operations (officially referred to as the <strong>clipboard selection</strong>), and then there’s the select-with-mouse-and-paste-with-middle-click variant (the <strong>primary selection</strong>). (There’s a third one called <strong>secondary selection</strong> too, but no one ever uses that for anything, as far as I’m aware. One less thing to worry about!)</p>
        <p>Most GUI apps handle the clipboard and primary selections just as expected (the GTK apps included with Crunchbang certainly do). The problems start when we want certain console apps—like tmux and Vim—that have their own internal buffers, to interoperate with X11 selections, so we can copy/paste text from them into GUI apps, and vice versa. This is also needed for clipboard interoperability with the guest OS; with bidirectional clipboard support enabled in VirtualBox, the Windows clipboard operations will use the X11 clipboard selection just like Linux GUI apps do (but note that the primary selection is not supported, so no middle-click copy/paste between the host and the guest).</p>
        <p>My general idea is to use the <kbd>Ctrl</kbd>+<kbd>X</kbd><kbd>C</kbd><kbd>V</kbd> shortcuts in tmux and Vim to interact with the clipboard selection, while retaining the ability to use their internal buffers with their native clipboard commands. Let’s see how we can achieve that!</p>
        <h4 id="vim">Vim</h4>
        <p>Teaching Vim how to do this is quite simple by defining the following mappings in our <code>.vimrc</code>:</p>
        <pre><code>vnoremap &lt;C-x&gt; "+x
vnoremap &lt;C-c&gt; "+y
noremap  &lt;C-v&gt; "+gP
inoremap &lt;C-v&gt; &lt;C-r&gt;+
</code></pre>
        <p>However, we now have just overridden the default <kbd>Ctrl</kbd>+<kbd>V</kbd> block selection shortcut. Let’s remap it to <kbd>Ctrl</kbd>+<kbd>Q</kbd> instead (gVim on Windows does the same thing by default, by the way ):</p>
        <pre><code>noremap &lt;C-q&gt; &lt;C-v&gt;
</code></pre>
        <p>This is almost good, but sadly it turns out that <kbd>Ctrl</kbd>+<kbd>Q</kbd> and <kbd>Ctrl</kbd>+<kbd>S</kbd> are reserved for an ancient terminal feature called <a href="https://en.wikipedia.org/wiki/Software_flow_control">flow control</a>. We definitely don’t need that, so let’s reclaim these shortcuts and put them to a better use:</p>
        <pre><code># reclaim Ctrl-S
stty stop undef

# reclaim Ctrl-Q
stty start undef
</code></pre>
        <p>Middle-click pasting from GUI apps into Vim works perfectly fine both in command and insert mode, so we’re done.</p>
        <h4 id="tmux">tmux</h4>
        <p>The situation gets a bit trickier in the case of tmux, which doesn’t have any direct support for X selections, so we’ll need to resort to external tools combined with some shell magic.</p>
        <p>The GTK+ clipboard manager <a href="https://github.com/CristianHenzel/ClipIt">ClipIt</a> included with Crunchbang has a command line interface that can interact with the system clipboard (in theory), however, I could never get it to work, and neither could others, according to the old Crunchbang forums. So we’ll need to grab another tool that does actually work, and the aptly titled <strong>xclip</strong> happens to just fit the bill:</p>
        <pre><code>sudo apt-get install xclip
</code></pre>
        <p>Armed with xclip, we can now configure tmux to pipe our selection to xclip when we hit <kbd>Ctrl</kbd>+<kbd>C</kbd> in vi-copy mode:</p>
        <pre><code>bind -t vi-copy "C-c" copy-pipe "xclip -selection clipboard"
</code></pre>
        <p>Pasting is a bit more difficult because tmux shortcuts have precedence over the Vim ones, so we’ll need to detect whether we’re pressing <kbd>Ctrl</kbd>+<kbd>V</kbd> in a Vim session inside a tmux pane or just in a regular terminal pane. In the Vim pane case we’ll simply pass the <kbd>Ctrl</kbd>+<kbd>V</kbd> through to Vim, otherwise we’ll execute our tmux specific paste magic. Without the passthrough trick tmux would send the contents of the clipboard to Vim as a sequence of commands to execute, which would be a total disaster in command mode. It would work in insert mode, though, but that’s a crappy half-assed solution— let’s just do this properly and make it work correctly in both modes! Here’s how (apologies for the two levels of escaping, but that’s unavoidable):</p>
        <pre><code>bind -n C-v if-shell "\$is_vim" "send-keys C-v" "run-shell \
    \"tmux set-buffer \\\"\$(xclip -o -selection clipboard)\\\"; \
    tmux paste-buffer\""
</code></pre>
        <p>This idea is taken from <a href="https://github.com/christoomey/vim-tmux-navigator">Vim Tmux Navigator</a>, and in fact, we are reusing the <code>is_vim</code> command from their tmux config snippet. For the sake of completeness (and because it contains a marvellously repulsive regular expression), I will include it here:</p>
        <pre class="no-math"><code>is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
</code></pre>
        <p>Quite obvious what it’s doing, isn’t it? I thought so too.</p>
        <h3 id="mouse-support">Mouse support</h3>
        <h4 id="vim-1">Vim</h4>
        <p>Enabling mouse support in Vim is surprisingly easy:</p>
        <pre><code>if has('mouse')
  set mouse=a
endif
</code></pre>
        <p>That’s it! This will let us navigate and resize splits with the mouse and use the select/middle-click primary clipboard mechanism. Of course, you’ll need a Vim version compiled with mouse support enabled for this (I recommend the kitchen-sink <code>vim-nox</code> package that contains support for basically all Vim features).</p>
        <h4 id="tmux-1">tmux</h4>
        <p>As we would expect, tmux is a harder nut to crack. The following will enable mouse support on tmux &lt;2.0 (1.9-6 is the latest stable version for Jessie).</p>
        <pre><code>set -g mode-mouse on
set -g mouse-resize-pane on
set -g mouse-select-pane on
set -g mouse-select-window on
</code></pre>
        <p>This is all good so far, but there are a few caveats with how mouse selections will interact with the system clipboard handling we have configured earlier. First of all, just selecting some text and then releasing the mouse button will copy the selection into the internal tmux buffer. If we want it to be copied into the clipboard selection instead, we must press <kbd>Ctrl</kbd>+<kbd>C</kbd> <em>before</em> releasing the mouse button!</p>
        <p>The handling of primary selections is similarly quirky: to paste the contents of the primary selection into a tmux pane, we must hold <kbd>Shift</kbd> while middle-clicking. To make a primary selection, we must again hold <kbd>Shift</kbd> while click-dragging, but this unfortunately bypasses tmux altogether, so multiline selections with vertically split panes won’t work very well (experiment with this a bit and you’ll see what I mean). The workaround for this is to maximise the pane before making the selection. To the best of my knowledge, there are no better solutions for the tmux primary selection issues at the moment.</p>
        <hr>
        <h2 id="installation">Installation</h2>
        <p>We’ll need the following ingredients:</p>
        <ul class="compact">
          <li>
            <a href="https://www.virtualbox.org/wiki/Downloads">VirtualBox 5.1.8</a> (or newer)
          </li>
          <li>
            <a href="https://crunchbangplusplus.org/">Crunchbang++ 1.0</a> 64-bit image (<a href="https://crunchbangplusplus.org/assets/misc/cbpp-1.0-amd64-20150428.iso.torrent">torrent</a>)
          </li>
          <li>Internet connection (Crunchbang is based on Debian netinstall)</li>
        </ul>
        <p>We’ll need to create a new VM with <em>Linux 2.6 / 3.x / 4.x (64-bit)</em> selected as the guest operating system type. <em>Debian (64-bit)</em> would probably work too, but I haven’t tested it. I’m on an Intel i7 4790k 4.0 GHz with 16 gigs of RAM, so I just allocated 4 CPU cores and 4 gigs to the new VM and created a 40 GB dynamic storage on an SSD partition (recommended). Pretty standard stuff, but pay attention to the following issues:</p>
        <ul>
          <li>
            <p>Make sure that <em>Enable PAE/NX System</em> is checked under <em>System / Processor / Extended Features</em>, otherwise the installer will fail.</p>
          </li>
          <li>
            <p>Check <em>Enable VT-x/AMD-V</em> under <em>System / Acceleration / Hardware Virtualization</em>, otherwise AVX passthrough won’t work (if this doesn’t make sense to you, then you have nothing to worry about). Of course, your processor must support that and it has to be enabled in the BIOS.</p>
          </li>
        </ul>
        <p>From this point it’s easy sailing—just insert the ISO and proceed with the install. I recommend using the text mode installer because the GUI one hung at some point during downloading the packages. Everything should be self-explanatory, just accept the default HDD partitioning scheme (or you can complicate things, up to you).</p>
        <h2 id="on-first-boot">On first boot</h2>
        <p>About 30-60 minutes later, we will be greeted by the <code>cbpp-welcome</code> script that will offer us to update the system and install some optional packages. We’ll do that, but later, so just exit for now. Our first objective is to get the desktop environment up and running, then we’ll do the system update, and finally we’ll fix a few issues and perform some other usability enhancements.</p>
        <h3 id="set-zsh-as-the-default-shell">Set zsh as the default shell</h3>
        <p>My first thing to do on a new system is switch to <strong>zsh</strong>, so let’s install that quickly with <code>sudo apt-get install zsh</code> and then set it as the default login shell. Just run <code>chsh</code> and enter <code>/bin/zsh</code> as the new value. Note that the change will only take effect on the next login.</p>
        <p>It is also recommended to set <code>x-terminal-emulator</code> to zsh because the built-in Openbox menus use it:</p>
        <pre><code>% sudo update-alternatives --config x-terminal-emulator
</code></pre>
        <h3 id="install-virtualbox-guest-additions">Install VirtualBox Guest Additions</h3>
        <p>We need to install the VirtualBox Guest Additions to get fullscreen, bidirectional clipboard and drag-and-drop support working. This will also make the screen updates snappier and it will fix the default jerky mouse pointer behaviour, which is quite horrible. But before we could proceed, the kernel headers must be installed first:</p>
        <pre><code>% sudo apt-get install linux-headers-$(uname -r)
</code></pre>
        <p>After this, select <em>Insert Guest Additions CD image…</em> in the <em>Devices</em> menu in VirtualBox. You might need to create a virtual optical drive first in the VM settings if you haven’t done so already (remember that you can only do that when the VM is shut down, otherwise the <em>Add optical drive</em> button on the <em>Storage</em> tab will be disabled).</p>
        <p>Now we can install the additions:</p>
        <pre><code>% cd /media/cdrom
% sudo sh ./VBoxLinuxAdditions.run
</code></pre>
        <p>Don’t forget to tick <em>Shared Clipboard</em> and <em>Drag’n’Drop</em> to <em>Bidirectional</em> under <em>General / Advanced</em> in the VM settings. Enter fullscreen mode (<kbd>R Ctrl</kbd>+<kbd>F</kbd>), reboot, and you should be rewarded for your efforts with a glorious fullscreen Crunchbang desktop sporting a fluid mouse pointer!</p>
        <h3 id="perform-system-update">Perform system update</h3>
        <p>CrunchBangPlusPlus 1.0 was released more than a year ago, so we should definitely update the system to the latest Debian Jessie packages. The easiest way to do this is to run the <code>cbpp-welcome</code> script again and let it update the software sources and the system (answer <em>Yes</em> to the first two questions). This will take a while, depending on the speed of your network (I think it took about an hour for me). After this, you’ll have the option to install a few more additional packages.</p>
        <h3 id="fix-compton">Fix Compton</h3>
        <p>For some reason, Compton (the compositor responsible for window transparency, drop shadows and other eye candy) could not start up properly in my VirtualBox setup. It turned out that the startup script tried to enable OpenGL vsync by default and that was causing the issues, so we’ll just disable that by commenting lines 18-20 out in <code>/usr/bin/cbpp-compositor</code>:</p>
        <pre><code>#if glxinfo | egrep -iq 'direct rendering: yes'; then
#    EXECXCOMP+=' --vsync opengl'
#fi
</code></pre>
        <p>Restart Compton by selecting <em>Settings / Compositor / Restart Compositing</em> in the Openbox right-click menu and take a quiet moment to marvel at the tasteful drop shadows around your window edges!</p>
        <h3 id="enable-autologin">Enable autologin</h3>
        <p>If you’re the sole user of this VM, you’ll probably want to enable autologin. Edit <code>/etc/slim.conf</code> and change the following three parameters:</p>
        <pre><code>login_cmd       exec /bin/bash -login /etc/X11/Xsession %session
auto_login      yes
default_user    YOUR_USERNAME
</code></pre>
        <h3 id="installing-powerline-fonts">Installing Powerline fonts</h3>
        <p>Some people maintain that one can live a full and prosperous life without <a href="https://github.com/powerline/fonts">Powerline fonts</a>. Needless to say, this is utter bollocks. Those in the know will surely follow my wise advice and issue the following sequence of commands:</p>
        <pre><code>% cd /tmp/
% wget https://github.com/powerline/fonts/archive/2015-12-04.zip
% unzip 2015-12-04.zip
% cd fonts-2015-12-04
% mkdir ~/.fonts/
% cp LiberationMono/Literation\ Mono\ Powerline.ttf ~/.fonts/
% fc-cache -vf ~/.fonts/
</code></pre>
        <h3 id="setting-the-right-wallpaper">Setting the <em>right</em> wallpaper</h3>
        <p>No desktop Linux setup is ever complete without a wallpaper, but, of course, the chosen wallpaper must be the <em>correct</em> one. Look no further than <a href="/files/2016-11-12/lotus.png">this</a>!</p>
        <p><br>
        … aaaand congratulations, you’re done. Enjoy your brand new vimified desktop! :)</p>
        <section class="links">
          <h2 id="further-reading">Further reading</h2>
          <ul class="compact">
            <li>
              <a href="https://xaizek.github.io/2016-08-13/big-list-of-vim-like-software/">The big list of Vi[m]-like software</a>
            </li>
          </ul>
        </section>
        <div class="footnotes">
          <ol>
            <li id="fn:linuxsucks">
              <p>There are a few good ones though, for example I’m using the Windows version of Inkscape, but there’s really no match for Lightroom or Photoshop (if you want to recommend me The Gimp at this point, please save your energy). Moreover, the driver support for (semi-)pro audio interfaces is just non-existent on Linux, and let’s not even talk about the audio software front… <a href="#fnref:linuxsucks" class="reversefootnote">↩</a></p>
            </li>
          </ol>
        </div>
        <section class="comments">
          <h2>Comments</h2><noscript>
          <p id="no-disqus"><i>Please enable JavaScript to view the comments.</i></p></noscript>
          <div id="disqus_thread"></div>
          <script type="text/javascript">
          var disqus_shortname = "johnnovak";
          var disqus_identifier = "/2016/11/13/a-minimalist-openbox-desktop-for-vim-freaks/";
          var disqus_title = "A minimalist Openbox desktop for Vim freaks";
          var disqus_url = "https://blog.johnnovak.net//2016/11/13/a-minimalist-openbox-desktop-for-vim-freaks/";

          (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
          </script>
        </section>
      </article>
    </div>
  </div>
</body>
</html>
